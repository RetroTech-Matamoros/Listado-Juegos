<script>

/* ===== DATA ===== */
let consolaActiva="";
let seleccionados = new Set(); // â† guarda juegos marcados

const juegos = { /* tu objeto juegos queda EXACTAMENTE igual */ };

const lista=document.getElementById("lista");
const buscador=document.getElementById("buscador");


/* ===== PANTALLAS ===== */
function start(){
  const val=consoleSelect.value;
  if(!val) return alert("Selecciona una consola");

  consolaActiva=val;
  titulo.textContent="ðŸŽ® "+val;

  consoleSection.style.display="none";
  gamesSection.style.display="block";

  render();
}

function volver(){
  gamesSection.style.display="none";
  consoleSection.style.display="block";
  lista.innerHTML="";
}


/* ===== RENDER (FIX PRINCIPAL) ===== */
function render(){

  lista.innerHTML="";

  juegos[consolaActiva].forEach(j=>{

    if(j[0].toLowerCase().includes(buscador.value.toLowerCase())){

      const marcado = seleccionados.has(j[0]) ? "checked" : "";

      lista.innerHTML+=`
      <div class="game">
        <label>
        <input type="checkbox"
               value="${j[1]}"
               data-name="${j[0]}"
               ${marcado}>
        ${j[0]} (${j[1]} GB)
        </label>
      </div>`;
    }
  });

  activar();
  recalcularBarra(); // â† restaura barra al filtrar
}

buscador.addEventListener("input",render);


/* ===== CALCULO ===== */
function activar(){

  document.querySelectorAll("input[type=checkbox]")
    .forEach(c=>{
      c.addEventListener("change", function(){

        const nombreJuego = this.dataset.name;

        if(this.checked){
          seleccionados.add(nombreJuego);
        }else{
          seleccionados.delete(nombreJuego);
        }

        recalcularBarra();
      });
    });
}


/* ===== NUEVO CALCULO GLOBAL ===== */
function recalcularBarra(){

  let total = 0;
  const cap = Number(capacidad.value);

  juegos[consolaActiva].forEach(j=>{
    if(seleccionados.has(j[0])){
      total += j[1];
    }
  });

  if(total>cap){
    alert("Excede la capacidad");
    return;
  }

  uso.textContent=`${total.toFixed(2)} / ${cap} GB`;
  bar.style.width=(total/cap*100)+"%";
}


/* ===== ENVIAR ===== */
async function enviar(){

  let juegosSel=[...seleccionados];

  let total=0;
  juegos[consolaActiva].forEach(j=>{
    if(seleccionados.has(j[0])) total+=j[1];
  });

  await fetch("TU_URL_AQUI",{
    method:"POST",
    body:JSON.stringify({
      nombre:nombre.value,
      capacidad:capacidad.value,
      juegos:juegosSel.join(", "),
      espacio:total
    })
  });

  alert("Pedido enviado âœ…");
}

</script>

